<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Administración</title>
  <link rel="stylesheet" href="admon.css">
</head>
<body>
  <header class="barra-superior">
    <h1>📊 Panel de Control</h1>
    <nav class="menu">
      <a href="admon.html">🏠 Inicio</a>
      <a href="registro_usuario.html">➕ Agregar usuario</a>
      <a href="usuario.html">👥 Ver usuarios</a>
      <a href="historial.html">📅 Historial</a>
      <a href="enable" onclick="accionBoton1()">🧪 Próximamente</a>
      <a href="enable" onclick="accionBoton2()">🧪 Próximamente</a>
      <a href="enable" onclick="accionBoton3()">🧪 Próximamente</a>
      <button id="logout">🚪 Cerrar sesión</button>
    </nav>
  </header>

  <div class="contenedor">
    <input type="text" id="filtro" placeholder="Buscar por matrícula o nombre...">

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Matrícula</th>
          <th>Nombre completo</th>
          <th>Grado y grupo</th>
          <th>Tipo</th>
          <th>Fecha</th>
          <th>Hora Entrada</th>
          <th>Hora Salida</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tabla_registros"></tbody>
    </table>
  </div>

  <div id="modal-editar-hora" class="modal">
    <div class="modal-contenido">
      <h3>Editar Horarios</h3>
      <form id="form-editar-hora">
        <input type="hidden" id="edit-id">
        <label>Hora de entrada (HH:MM:SS):</label>
        <input type="text" id="edit-hora-entrada" placeholder="HH:MM:SS">
        <label>Hora de salida (HH:MM:SS):</label>
        <input type="text" id="edit-hora-salida" placeholder="HH:MM:SS">
        <div class="botones">
          <button type="submit">Guardar</button>
          <button type="button" onclick="cerrarModal()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    if (localStorage.getItem("sesionIniciada") !== "true") {
      window.location.href = "login2.html";
    }

    document.getElementById("logout").addEventListener("click", () => {
      localStorage.removeItem("sesionIniciada");
      window.location.href = "login2.html";
    });

    function accionBoton1() { alert("Próxima actualización"); }
    function accionBoton2() { alert("Próxima actualización"); }
    function accionBoton3() { alert("Próxima actualización"); }

    function cerrarModal() {
      document.getElementById("modal-editar-hora").style.display = "none";
    }

    function editarHora(id, entrada, salida) {
      document.getElementById("modal-editar-hora").style.display = "block";
      document.getElementById("edit-id").value = id;
      document.getElementById("edit-hora-entrada").value = entrada;
      document.getElementById("edit-hora-salida").value = salida;
    }

    async function cargarRegistros() {
      const res = await fetch("https://pagina-oficial-amhj.onrender.com/registros");
      const data = await res.json();
      const tbody = document.getElementById("tabla_registros");
      tbody.innerHTML = "";

      data.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${r.matricula}</td>
          <td>${r.nombres} ${r.apellido_paterno} ${r.apellido_materno}</td>
          <td>${r.grado || ""} ${r.grupo || ""}</td>
          <td>${r.tipo}</td>
          <td>${r.fecha}</td>
          <td>${r.hora_entrada}</td>
          <td>${r.hora_salida}</td>
          <td>
            <button onclick="editarHora(${r.id}, '${r.hora_entrada || ''}', '${r.hora_salida || ''}')">✏️ Editar</button>
            <button onclick="eliminarRegistro(${r.id})" style="color:red;">🗑️</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function eliminarRegistro(id) {
      if (!confirm("¿Estás seguro de que deseas eliminar este registro?")) return;
      try {
        const res = await fetch(`https://pagina-oficial-amhj.onrender.com/eliminar-registro/${id}`, {
          method: "DELETE"
        });
        const result = await res.json();
        alert(result.mensaje || "Registro eliminado");
        cargarRegistros();
      } catch (error) {
        alert("❌ No se pudo eliminar el registro");
        console.error(error);
      }
    }

    document.getElementById("form-editar-hora").addEventListener("submit", async e => {
      e.preventDefault();
      const id = document.getElementById("edit-id").value;
      const entrada = document.getElementById("edit-hora-entrada").value;
      const salida = document.getElementById("edit-hora-salida").value;
      const res = await fetch("/actualizar-horarios", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, entrada, salida })
      });
      const result = await res.json();
      alert(result.mensaje);
      if (result.success) {
        cerrarModal();
        cargarRegistros();
      }
    });

    document.getElementById("filtro").addEventListener("input", e => {
      const filtro = e.target.value.toLowerCase();
      document.querySelectorAll("#tabla_registros tr").forEach(tr => {
        tr.style.display = tr.innerText.toLowerCase().includes(filtro) ? "" : "none";
      });
    });

    cargarRegistros();
  </script>
</body>
</html>

