<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reporte de Conducta</title>
  <link rel="stylesheet" href="reporte.css">
</head>
<body>
  <div class="contenedor">
    <h2>üìã Reporte de Conducta Individual</h2>
    <form id="form-reporte">
      <label>Nombre del alumno:</label>
      <input type="text" id="nombre_alumno" placeholder="Nombre del alumno" readonly><br>
    
      <label>Matr√≠cula del alumno:</label>
      <input type="text" id="matricula_alumno" placeholder="Matr√≠cula del alumno" required><br>
        <!-- Campo oculto para la matr√≠cula del docente -->
<input type="hidden" id="matricula_docente">
    
      <label>Grado:</label>
      <select id="grado" required>
        <option value="">Grado</option>
        <option>1</option>
        <option>2</option>
        <option>3</option>
      </select><br>
    
      <label>Grupo:</label>
      <select id="grupo" required>
        <option value="">Grupo</option>
        <option>A</option>
        <option>B</option>
        <option>C</option>
        <option>D</option>
        <option>E</option>
      </select><br>
    
      <label>Clase:</label>
      <select id="clase" required>
        <option value="">Selecciona</option>
        <option>Espa√±ol</option>
        <option>Lectura</option>
        <option>Ingl√©s</option>
        <option>Matem√°ticas</option>
        <option>Ciencias</option>
        <option>Geograf√≠a</option>
        <option>Historia</option>
        <option>F. C y E</option>
        <option>Educaci√≥n f√≠sica</option>
        <option>Vida saludable</option>
        <option>Artes</option>
        <option>Tutor√≠a</option>
        <option>Taller</option>
        <option>Otro</option>
      </select><br>
    
      <label>Hora:</label>
      <select id="hora" required>
        <option value="">Selecciona</option>
        <option>1a</option><option>2a</option><option>3a</option><option>4a</option>
        <option>5a</option><option>6a</option><option>7a</option><option>8a</option>
        <option>9a</option><option>1er descanso</option><option>2o descanso</option>
      </select><br>
    
      <label>Descripci√≥n de la conducta:</label><br>
      <textarea id="contenido" rows="5" required></textarea><br>
    
      <input type="submit" value="Enviar Reporte">
    </form>
    <div id="mensaje"></div>
    <script>
      const docente = JSON.parse(localStorage.getItem("usuarioActual") || "{}");
      document.getElementById("matricula_docente").value = docente.usuario || "";
      console.log("DOCENTE:", docente);
      document.getElementById("matricula_alumno").addEventListener("input", async () => {
        const matricula = document.getElementById("matricula_alumno").value.trim();
    
        if (matricula.length < 4) return;
    
        try {
          const res = await fetch(`https://pagina-oficial-amhj.onrender.com/api/usuarios/${matricula}`);
          const data = await res.json();
    
          if (data.error) {
            document.getElementById("nombre_alumno").value = "";
            document.getElementById("grado").value = "";
            document.getElementById("grupo").value = "";
            return;
          }
    
          document.getElementById("nombre_alumno").value = `${data.nombre} ${data.apellido_paterno} ${data.apellido_materno}`;
          document.getElementById("grado").value = data.grado;
          document.getElementById("grupo").value = data.grupo;
        } catch (err) {
          console.error("‚ùå Error al obtener alumno:", err);
        }
      });
    
      document.getElementById("form-reporte").addEventListener("submit", async e => {
        
          e.preventDefault(); // üëà Esto va primero
        
        if (!docente.usuario) {
  alert("Error: no se ha detectado el usuario docente. Por favor inicia sesi√≥n.");
  return;
}
        const data = {
          matricula_alumno: document.getElementById("matricula_alumno").value.trim(),
          matricula_docente: document.getElementById("matricula_docente").value,
          fecha: new Date().toLocaleDateString("es-MX"),
          clase: document.getElementById("clase").value,
          hora: document.getElementById("hora").value,
          contenido: document.getElementById("contenido").value
        };
    
        const res = await fetch("https://pagina-oficial-amhj.onrender.com/api/reportes", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
    
        const result = await res.json();
        document.getElementById("mensaje").textContent = result.mensaje || "Reporte enviado con √©xito.";
        document.getElementById("form-reporte").reset();
        document.getElementById("nombre_alumno").value = "";
      });
    </script>    
</body>
</html>