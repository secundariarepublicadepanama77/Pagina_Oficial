<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Alerta Temprana</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <link rel="stylesheet" href="pase_lista.css">
</head>
<body>
  <h2>ALERTA TEMPRANA</h2>

  <label for="grado">Grado:</label>
  <select id="grado">
    <option value="">Selecciona</option>
    <option value="1">1Â°</option>
    <option value="2">2Â°</option>
    <option value="3">3Â°</option>
  </select>

  <label for="grupo">Grupo:</label>
  <select id="grupo">
    <option value="">Selecciona</option>
    <option value="A">A</option>
    <option value="B">B</option>
    <option value="C">C</option>
    <option value="D">D</option>
    <option value="E">E</option>
  </select>

  <label for="materia">Materia:</label>
  <select id="materia">
    <option value="">Selecciona</option>
    <option>EspaÃ±ol</option>
    <option>InglÃ©s</option>
    <option>MatemÃ¡ticas</option>
    <option>Ciencias</option>
    <option>Historia</option>
    <option>Taller</option>
  </select>

  <label for="trimestre">Trimestre:</label>
  <select id="trimestre">
    <option value="">Selecciona</option>
    <option value="1">1Â°</option>
    <option value="2">2Â°</option>
    <option value="3">3Â°</option>
  </select>

  <button onclick="cargarAlumnos()">Cargar alumnos</button>

  <table id="tabla-alertas">
    <thead>
      <tr>
        <th>#</th>
        <th>MatrÃ­cula</th>
        <th>Nombre</th>
        <th>Alerta</th>
      </tr>
    </thead>
    <tbody id="cuerpo-tabla"></tbody>
  </table>

  <button onclick="guardarAlertas()">Guardar alertas</button>

  <script>
    // Inicializa Supabase
    const supabase = window.supabase.createClient(
      'https://mhnzjhelbupyifdlpngv.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1obnpqaGVsYnVweWlmZGxwbmd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkyMTg1MjUsImV4cCI6MjA2NDc5NDUyNX0.tZAtvUL6kAFfEhwrXgopbQLcnq9qCCm5zpPBkm6z8wY'
    );

    // Inicializa EmailJS
    emailjs.init("rMAlPzvhYdLsr2IMy");

    async function cargarAlumnos() {
      const grado = document.getElementById("grado").value;
      const grupo = document.getElementById("grupo").value;

      if (!grado || !grupo) {
        alert("Selecciona grado y grupo.");
        return;
      }

      const { data, error } = await supabase
        .from("usuarios")
        .select("usuario, nombre, apellido_paterno, apellido_materno")
        .eq("grado", grado)
        .eq("grupo", grupo)
        .eq("tipo", "alumno")
        .order("apellido_paterno", { ascending: true });

      if (error || !data.length) {
        alert("No se encontraron alumnos.");
        return;
      }

      const cuerpo = document.getElementById("cuerpo-tabla");
      cuerpo.innerHTML = "";

      data.forEach((alumno, index) => {
        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td>${index + 1}</td>
          <td>${alumno.usuario}</td>
          <td>${alumno.nombre} ${alumno.apellido_paterno} ${alumno.apellido_materno}</td>
          <td>
            <select data-matricula="${alumno.usuario}">
              <option value="verde">âœ… Verde</option>
              <option value="rojo">ğŸš¨ Rojo</option>
            </select>
          </td>
        `;
        cuerpo.appendChild(fila);
      });
    }

    async function guardarAlertas() {
  const materia = document.getElementById("materia").value;
  const trimestre = document.getElementById("trimestre").value;
  const selects = document.querySelectorAll('td select');

  if (!materia || !trimestre) {
    alert("Selecciona materia y trimestre.");
    return;
  }

  let total = 0;

  for (const select of selects) {
    const matricula = select.dataset.matricula;
    const alerta = select.value;

    const { data: alumno, error } = await supabase
      .from("usuarios")
      .select("usuario, nombre, apellido_paterno, apellido_materno, grado, grupo, email")
      .eq("usuario", matricula)
      .single();

    if (!alumno || error) continue;

    await supabase
      .from("alertas")
      .insert([{
        matricula: alumno.usuario,
        nombre: `${alumno.nombre} ${alumno.apellido_paterno} ${alumno.apellido_materno}`,
        grado: alumno.grado,
        grupo: alumno.grupo,
        materia,
        alerta,
        trimestre
      }]);

    total++;

    // Solo para el primer alumno, para sacar grado/grupo/email del docente
    var grado = alumno.grado;
    var grupo = alumno.grupo;
    var correoDocente = alumno.email;
  }

  // Enviar correo
  if (correoDocente) {
    emailjs.send("service_y15ev6l", "template_rbd3zrf", {
      email: correoDocente,
      to_name: "Profesor",
      materia,
      grado,
      grupo,
      trimestre,
      total
    }).then(() => {
      alert("âœ… Alertas guardadas y correo enviado al docente.");
      window.location.href = "menu-docente.html";
    }, (err) => {
      console.error("âŒ Error enviando correo:", err);
      alert("âœ… Alertas guardadas pero no se pudo enviar correo.");
      window.location.href = "menu-docente.html";
    });
  } else {
    alert("âœ… Alertas guardadas pero no se encontrÃ³ correo del docente.");
    window.location.href = "menu-docente.html";
  }
}
  </script>
</body>
</html>
