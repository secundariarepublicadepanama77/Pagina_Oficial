<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Usuarios registrados</title>
  <link rel="stylesheet" href="menu.css">
</head>
<body>
  <header class="menu-encabezado">
    <img src="img/logo.png" alt="Logo" class="logo">
    <h1>Usuarios Registrados</h1>
  </header>
  <nav class="barra-botones">
    <a href="menu-admin.html">üè† Inicio</a>
    <a href="asistencia.html">üìã Sistema de asistencia</a>
    <a href="#">üìÅ Materiales</a>
    <a href="agregar-usuario.html">‚ûï Agregar usuarios</a>
    <a href="usuarios.html">üë§ Usuarios</a>
    <a href="login.html">üö™ Cerrar sesi√≥n</a>
    <a class="disabled">üîí Pr√≥ximamente</a>
    <a class="disabled">üîí Pr√≥ximamente</a>
  </nav>
  
  <main class="contenido-menu">
    <div class="tabla-contenedor">
      <h2>Lista de usuarios registrados</h2>
      <table id="tabla-usuarios">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Usuario</th>
            <th>Tipo</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
        <!-- Usuarios cargados por JavaScript -->
      </tbody>
    </table>
    <div id="mensaje" style="margin-top: 1rem; color: red;"></div>
    <!-- Modal de edici√≥n -->
<div id="modal-editar" class="modal" style="display: none;">
    <div class="modal-contenido">
      <h3>Editar Usuario</h3>
      <form id="form-editar-usuario">
        <input type="hidden" id="edit-id">
        
        <label for="edit-nombre">Nombre:</label>
        <input type="text" id="edit-nombre" required>
        
        <label for="edit-usuario">Usuario:</label>
        <input type="text" id="edit-usuario" required>
        
        <label for="edit-tipo">Tipo:</label>
        <select id="edit-tipo" required>
          <option value="admin">Administrativo</option>
          <option value="docente">Docente</option>
          <option value="alumno">Alumno</option>
        </select>
        
        <button type="submit">Guardar cambios</button>
        <button type="button" onclick="cerrarModal()">Cancelar</button>
      </form>
    </div>
  </div>  
  </main>

  <footer class="pie">
    ¬© Escuela Secundaria No. 77 ‚ÄúRep√∫blica de Panam√°‚Äù. Academia de Tecnolog√≠as
  </footer>
  <script>
    let usuariosGlobal = [];
  
    async function cargarUsuarios() {
      const respuesta = await fetch("/api/matriculas");
      const datos = await respuesta.json();
      usuariosGlobal = datos;
      const cuerpo = document.querySelector("#tabla-usuarios tbody");
      cuerpo.innerHTML = "";
  
      datos.forEach(usuario => {
        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td>${usuario.matricula}</td>
          <td>${usuario.nombres} ${usuario.apellido_paterno} ${usuario.apellido_materno}</td>
          <td>${usuario.tipo}</td>
          <td>${usuario.grado || ""}</td>
          <td>${usuario.grupo || ""}</td>
          <td>${usuario.ciclo_escolar || ""}</td>
          <td>
            <button onclick="eliminarUsuario('${usuario.matricula}')">üóëÔ∏è Eliminar</button>
            <button onclick="modificarUsuario('${usuario.matricula}')">‚úèÔ∏è Editar</button>
          </td>
        `;
        cuerpo.appendChild(fila);
      });
    }
  
    async function eliminarUsuario(matricula) {
      if (confirm("¬øEst√°s seguro de eliminar este usuario?")) {
        const respuesta = await fetch(`/api/matriculas/${matricula}`, {
          method: "DELETE"
        });
        const resultado = await respuesta.json();
        if (respuesta.ok && resultado.success) {
          alert("‚úÖ Usuario eliminado");
          cargarUsuarios();
        } else {
          alert("‚ùå Error: " + resultado.mensaje);
        }
      }
    }
  
    function modificarUsuario(matricula) {
      const usuario = usuariosGlobal.find(u => u.matricula === matricula);
      if (!usuario) return alert("Usuario no encontrado");
  
      document.getElementById("edit-id").value = usuario.matricula;
      document.getElementById("edit-nombre").value = usuario.nombres;
      document.getElementById("edit-apellido_paterno").value = usuario.apellido_paterno;
      document.getElementById("edit-apellido_materno").value = usuario.apellido_materno;
      document.getElementById("edit-grado").value = usuario.grado || "";
      document.getElementById("edit-grupo").value = usuario.grupo || "";
      document.getElementById("edit-ciclo").value = usuario.ciclo_escolar;
      document.getElementById("edit-tipo").value = usuario.tipo;
  
      document.getElementById("modal-editar").style.display = "flex";
    }
  
    function cerrarModal() {
      document.getElementById("modal-editar").style.display = "none";
    }
  
    document.getElementById("form-editar-usuario").addEventListener("submit", async function(e) {
      e.preventDefault();
      const datos = {
        matricula: document.getElementById("edit-id").value,
        nombres: document.getElementById("edit-nombre").value,
        apellido_paterno: document.getElementById("edit-apellido_paterno").value,
        apellido_materno: document.getElementById("edit-apellido_materno").value,
        grado: document.getElementById("edit-grado").value,
        grupo: document.getElementById("edit-grupo").value,
        ciclo_escolar: document.getElementById("edit-ciclo").value,
        tipo: document.getElementById("edit-tipo").value
      };
  
      const respuesta = await fetch("/api/matriculas", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos)
      });
  
      const resultado = await respuesta.json();
  
      if (respuesta.ok && resultado.success) {
        alert("‚úÖ Usuario actualizado");
        cerrarModal();
        cargarUsuarios();
      } else {
        alert("‚ùå Error: " + resultado.mensaje);
      }
    });
  
    window.onload = cargarUsuarios;
  </script>
  
</body>
</html>
