<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Iniciar sesi√≥n</title>
  <link rel="stylesheet" href="login.css">
</head>
<body>
  <div class="fondo-login">
    <div class="formulario-contenedor">
      <img src="img/logo.png" alt="Logo escuela" class="logo-login">
      <h2>Inicia sesi√≥n</h2>

      <form id="form-login">
        <input type="text" id="usuario" placeholder="Usuario" required>
        <input type="password" id="contrasena" placeholder="Contrase√±a" required>
        <div class="botones">
          <a href="index.html" class="btn-volver">Volver</a>
          <button type="submit" class="btn-ingresar">Ingresar</button>
        </div>
      </form>      

      <div id="mensaje" style="margin-top: 1rem; color: red;"></div>
    </div>
  </div>
  <script>
    document.getElementById("form-login").addEventListener("submit", async function (event) {
      event.preventDefault();
  
      const datos = {
        usuario: document.getElementById("usuario").value.trim(),
        contrasena: document.getElementById("contrasena").value
      };
  
      try {
        const respuesta = await fetch("/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(datos)
        });
  
        const resultado = await respuesta.json();
        const mensaje = document.getElementById("mensaje");
  
        if (respuesta.ok) {
          localStorage.setItem("usuarioID", resultado.id);
localStorage.setItem("nombreUsuario", resultado.nombre);
localStorage.setItem("tipoUsuario", resultado.tipo);
localStorage.setItem("matriculaUsuario", datos.usuario); // ‚úÖ Usa el valor correcto del formulario

localStorage.setItem("usuarioActual", JSON.stringify({
  usuario: datos.usuario,
  tipo: resultado.tipo,
  nombre: resultado.nombre
}));


          if (resultado.tipo === "administrativo") {
                window.location.href = "menu-admin.html";
} else if (resultado.tipo === "maestro") {
  window.location.href = "menu-docente.html";
} else if (resultado.tipo === "alumno") {
  window.location.href = "menu-alumno.html";
} else {
  mensaje.innerText = "‚ùå Tipo de usuario no reconocido: " + resultado.tipo;
}

        } else {
          mensaje.innerText = "‚ùå " + resultado.error;
        }
      } catch (error) {
        document.getElementById("mensaje").innerText = "‚ùå Error al conectar con el servidor";
      }
    });
  </script>
  <script>
    // Bloqueo de clic derecho
    document.addEventListener("contextmenu", e => e.preventDefault());
  
    //  Bloqueo de teclas: F12, Ctrl+U, Ctrl+Shift+I, Ctrl+Shift+C
    document.addEventListener("keydown", e => {
      const bloqueadas = [
        "F12",
        "u", // Ctrl+U
        "i", // Ctrl+Shift+I
        "c"  // Ctrl+Shift+C
      ];
      if (
        bloqueadas.includes(e.key.toLowerCase()) && 
        (e.ctrlKey || e.metaKey || e.shiftKey)
      ) {
        e.preventDefault();
        console.log("üö´ Acci√≥n bloqueada");
      }
    });
  </script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  
    const supabase = createClient(
      'https://mhnzjhelbupyifdlpngv.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1obnpqaGVsYnVweWlmZGxwbmd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkyMTg1MjUsImV4cCI6MjA2NDc5NDUyNX0.tZAtvUL6kAFfEhwrXgopbQLcnq9qCCm5zpPBkm6z8wY'
    );
  
    const matricula = localStorage.getItem("matriculaUsuario");
  
    if (matricula) {
      const { data, error } = await supabase
        .from("usuarios")
        .select("usuario, nombre, apellido_paterno, apellido_materno, grado, grupo")
        .eq("usuario", matricula)
        .single();
  
      if (error || !data) {
        console.error("‚ùå No se pudieron obtener los datos del alumno:", error);
      } else {
        document.getElementById("matriculaAlumno").textContent = data.usuario;
        document.getElementById("nombreAlumno").textContent = `${data.nombre} ${data.apellido_paterno} ${data.apellido_materno}`;
        document.getElementById("grupoAlumno").textContent = `${data.grado || '‚Äî'}¬∞ ${data.grupo || '‚Äî'}`;
      }
    } else {
      console.warn("‚ö†Ô∏è No se encontr√≥ matr√≠cula en localStorage");
    }
  </script>  
</body>
</html>
