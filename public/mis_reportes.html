<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mis Reportes</title>
  <link rel="stylesheet" href="menu.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <!-- Encabezado -->
  <header class="menu-encabezado">
    <img src="img/logo.png" alt="Logo" class="logo" />
    <h1>Panel del Alumno</h1>
  </header>

  <!-- Barra de botones del alumno -->
  <nav class="barra-botones">
    <a href="menu-alumno.html">ğŸ  Inicio</a>
    <a href="#">ğŸ“… Horario</a>
    <a href="mis_reportes.html" class="activo">ğŸ“ Reportes</a>
    <a class="disabled">ğŸ“ Calificaciones</a>
    <a class="disabled">ğŸ’¬ Mensajes</a>
    <a class="disabled">ğŸ”’ PrÃ³ximamente</a>
    <a class="disabled">ğŸ”’ PrÃ³ximamente</a>
    <a href="#" onclick="cerrarSesion()">ğŸšª Cerrar sesiÃ³n</a>
  </nav>

  <!-- Contenido principal -->
  <main class="contenido-menu">
    <section class="filtros-reportes">
      <h2>ğŸ“‹ Mis Reportes de Conducta</h2>
      <label>ğŸ“… Fecha:
        <input type="date" id="filtroFecha">
      </label>
      <label>ğŸ“˜ Clase:
        <input type="text" id="filtroClase" placeholder="Ej. Historia">
      </label>
      <label>ğŸ” Palabra clave:
        <input type="text" id="filtroPalabra" placeholder="Ej. celular">
      </label>
      <button onclick="cargarReportes()">Buscar</button>
      <button onclick="descargarExcel()">â¬‡ï¸ Excel</button>
      <button onclick="descargarPDF()">â¬‡ï¸ PDF</button>
    </section>

    <section id="reportes-conducta">
      <table id="tabla-completa">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Clase</th>
            <th>Hora</th>
            <th>DescripciÃ³n</th>
            <th>Docente</th>
            <th>Tipo</th>
          </tr>
        </thead>
        <tbody id="tabla-reportes">
          <!-- Se insertan dinÃ¡micamente -->
        </tbody>
      </table>
      <div id="mensaje" style="color: red; margin-top: 1rem;"></div>
    </section>
  </main>

  <!-- Pie de pÃ¡gina -->
  <footer class="pie">
    Â© Escuela Secundaria No. 77 â€œRepÃºblica de PanamÃ¡â€. Academia de TecnologÃ­as
  </footer>

  <script>
    const alumno = JSON.parse(localStorage.getItem("usuarioActual") || "{}");
    const matricula = alumno.usuario;
    let datosFiltrados = [];

    function cargarReportes() {
      const fecha = document.getElementById("filtroFecha").value;
      const clase = document.getElementById("filtroClase").value;
      const palabra = document.getElementById("filtroPalabra").value.toLowerCase();

      let url = `https://pagina-oficial-amhj.onrender.com/api/reportes/alumno/${matricula}`;
      const params = [];
      if (fecha) params.push(`fecha=${fecha}`);
      if (clase) params.push(`clase=${encodeURIComponent(clase)}`);
      if (params.length > 0) url += "?" + params.join("&");

      fetch(url)
        .then(res => res.json())
        .then(data => {
          const tabla = document.getElementById("tabla-reportes");
          tabla.innerHTML = "";

          datosFiltrados = palabra
            ? data.filter(r => r.contenido.toLowerCase().includes(palabra))
            : data;

          if (!datosFiltrados || datosFiltrados.length === 0) {
            tabla.innerHTML = `<tr><td colspan="6">No hay reportes</td></tr>`;
            return;
          }

          datosFiltrados.forEach(reporte => {
            let tipo = "Leve";
            let color = "ğŸŸ¢";
            const texto = reporte.contenido.toLowerCase();
            if (texto.includes("grit") || texto.includes("agres")) {
              tipo = "Grave"; color = "ğŸ”´";
            } else if (texto.includes("molest") || texto.includes("interrump")) {
              tipo = "Moderado"; color = "ğŸŸ ";
            }

            const fila = `
              <tr>
                <td>${reporte.fecha}</td>
                <td>${reporte.clase}</td>
                <td>${reporte.hora}</td>
                <td>${reporte.contenido}</td>
                <td>${reporte.nombre_docente || "â€”"}</td>
                <td>${color} ${tipo}</td>
              </tr>
            `;
            tabla.innerHTML += fila;
          });
        })
        .catch(err => {
          document.getElementById("mensaje").innerText = "âŒ Error al cargar reportes";
          console.error(err);
        });
    }

    function descargarExcel() {
      const ws = XLSX.utils.table_to_sheet(document.getElementById("tabla-completa"));
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Reportes");
      XLSX.writeFile(wb, "reportes_conducta.xlsx");
    }

    async function descargarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("Reporte de Conducta", 20, 20);

      let y = 30;
      datosFiltrados.forEach(r => {
        doc.text(`ğŸ“… ${r.fecha} | ${r.clase} | ${r.hora}`, 20, y);
        y += 7;
        doc.text(`ğŸ‘¤ Docente: ${r.nombre_docente || "â€”"}`, 20, y);
        y += 7;
        doc.text(`ğŸ“ ${r.contenido}`, 20, y);
        y += 10;
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
      });

      doc.save("reportes_conducta.pdf");
    }

    window.onload = cargarReportes;
  </script>
  <script>
    // ğŸ”’ Bloqueo de clic derecho
    document.addEventListener("contextmenu", e => e.preventDefault());
  
    // ğŸ”’ Bloqueo de teclas: F12, Ctrl+U, Ctrl+Shift+I, Ctrl+Shift+C
    document.addEventListener("keydown", e => {
      const bloqueadas = [
        "F12",
        "u", // Ctrl+U
        "i", // Ctrl+Shift+I
        "c"  // Ctrl+Shift+C
      ];
      if (
        bloqueadas.includes(e.key.toLowerCase()) && 
        (e.ctrlKey || e.metaKey || e.shiftKey)
      ) {
        e.preventDefault();
        console.log("ğŸš« AcciÃ³n bloqueada");
      }
    });
  </script>  
</body>
</html>
