<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Perfil del Alumno - Calificaciones</title>
  <link rel="stylesheet" href="menu.css" />
  <link rel="stylesheet" href="cal.css" />
</head>
<body>

<header class="menu-encabezado">
  <img src="img/PRPM/logo.png" alt="Logo" class="logo" />
  <h1>Perfil del Alumno</h1>
</header>

<nav class="barra-botones">
  <a href="menu-alumno.html">🏠 Inicio</a>
  <a href="horario.html">📅 Horario</a>
  <a href="mis_reportes.html">📝 Reportes</a>
  <a class="disabled">🎓 Calificaciones</a>
  <a class="disabled">💬 Mensajes</a>
  <a class="disabled">🔒 Próximamente</a>
  <a class="disabled">🔒 Próximamente</a>
  <a href="login.html" onclick="cerrarSesion()">🚪 Cerrar sesión</a>
</nav>

<main class="calificaciones-panel">
  <h2 id="saludo">👋 Hola, Ciclo 2025-2026</h2>

  <!-- Contenedor de tablas por trimestre -->
  <div class="contenedor-trimestres">
    <div class="tabla-trimestre">
      <h3>1er Trimestre</h3>
      <table class="tabla-resultados" id="tabla-trimestre-1"></table>
    </div>
    <div class="tabla-trimestre">
      <h3>2do Trimestre</h3>
      <table class="tabla-resultados" id="tabla-trimestre-2"></table>
    </div>
    <div class="tabla-trimestre">
      <h3>3er Trimestre</h3>
      <table class="tabla-resultados" id="tabla-trimestre-3"></table>
    </div>
  </div>

  <!-- Promedio final -->
  <div class="promedio-final" id="promedioFinal">
    🏆 Promedio final: -
  </div>

  <!-- Alerta temprana -->
  <div id="alertaBox" class="alerta-temprana">
    Cargando alertas...
  </div>
</main>

<footer class="pie">
  © Escuela Secundaria No. 77 “República de Panamá”. Academia de Tecnologías
</footer>

<script>
  function cerrarSesion() {
    localStorage.clear();
    window.location.href = "login.html";
  }
</script>
<script src="Bloqueos.js"></script>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const supabase = createClient(
    "https://mhnzjhelbupyifdlpngv.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  );

  const matricula = localStorage.getItem("matriculaUsuario");
  const nombre = localStorage.getItem("nombreUsuario") || "Alumno";

  document.getElementById("saludo").innerText = `👋 Hola ${nombre}, Ciclo 2025-2026`;

  const trimestres = {
    1: document.getElementById("tabla-trimestre-1"),
    2: document.getElementById("tabla-trimestre-2"),
    3: document.getElementById("tabla-trimestre-3")
  };

  const colores = {
    rojo: "background-color: #f44336; color: white;",
    verde: "background-color: #4CAF50; color: white;"
  };

  if (matricula) {
    const { data, error } = await supabase
      .from("alertas")
      .select("materia, estado, trimestre")
      .eq("usuario", matricula);

    if (error || !data) {
      console.error("❌ Error al obtener alertas:", error?.message);
      document.getElementById("alertaBox").innerText = "⚠️ No se pudieron cargar los resultados.";
    } else {
      let materiasEnRiesgo = 0;

      // Agrupar por trimestre
      const agrupadas = { 1: [], 2: [], 3: [] };
      data.forEach(row => {
        const fila = `<tr>
          <td>${row.materia}</td>
          <td style="${colores[row.estado] || ''}">${row.estado}</td>
        </tr>`;
        agrupadas[row.trimestre]?.push(fila);
        if (row.estado === "rojo") materiasEnRiesgo++;
      });

      // Insertar tablas
      [1, 2, 3].forEach(t => {
        const tabla = agrupadas[t].join("") || "<tr><td colspan='2'>Sin datos</td></tr>";
        trimestres[t].innerHTML = `<tr><th>Materia</th><th>Estado</th></tr>${tabla}`;
      });

      // Mostrar alerta temprana
      const alertaBox = document.getElementById("alertaBox");
      if (materiasEnRiesgo > 0) {
        alertaBox.innerHTML = `⚠️ Atención: Tienes <strong>${materiasEnRiesgo}</strong> materias en riesgo (Alerta Temprana).`;
        alertaBox.classList.add("alerta-roja");
      } else {
        alertaBox.innerHTML = `✅ ¡Todo bien! No tienes materias en riesgo.`;
        alertaBox.classList.add("alerta-verde");
      }
    }
  } else {
    document.getElementById("alertaBox").innerText = "⚠️ No se encontró matrícula";
  }
</script>

</body>
</html>
