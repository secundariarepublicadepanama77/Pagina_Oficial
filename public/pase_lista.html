<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Pase de Lista</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid black; padding: 6px; text-align: center; }
    th { background-color: lightgray; }
    input[type="checkbox"] { transform: scale(1.3); }
    textarea { width: 90%; height: 40px; }
  </style>
</head>
<body>
  <h2>PASE DE LISTA</h2>

  <label for="grado">Grado:</label>
  <select id="grado">
    <option value="">Selecciona</option>
    <option value="1">1°</option>
    <option value="2">2°</option>
    <option value="3">3°</option>
  </select>

  <label for="grupo">Grupo:</label>
  <select id="grupo">
    <option value="">Selecciona</option>
    <option value="A">A</option>
    <option value="B">B</option>
    <option value="C">C</option>
  </select>

  <button onclick="cargarAlumnos()">Cargar alumnos</button>
  <label for="materia">Materia:</label>
<select id="materia">
  <option value="">Selecciona</option>
  <option value="Español">Español</option>
  <option value="Inglés">Inglés</option>
  <option value="Matemáticas">Matemáticas</option>
  <option value="Ciencias">Ciencias</option>
  <option value="Historia">Historia</option>
  <option value="Taller">Taller</option>
</select>
  <p><strong>Fecha:</strong> 
    <input type="date" id="fecha" />
  </p>
  
  <table id="tabla-asistencia">
    <thead>
      <tr>
        <th>#</th>
        <th>Matrícula</th>
        <th>Nombre completo</th>
        <th>Asistió</th>
        <th>Observaciones</th>
      </tr>
    </thead>
    <tbody id="cuerpo-tabla"></tbody>
  </table>

  <button onclick="guardarAsistencia()">Guardar pase de lista</button>

  <script>
    const supabase = supabase.createClient('https://TU-PROYECTO.supabase.co', 'TU-CLAVE-ANON');
    const fechaHoy = new Date().toISOString().split('T')[0];
    document.getElementById("fecha").value = fechaHoy;

    document.getElementById("fecha").textContent = fechaHoy;

    async function cargarAlumnos() {
      const grado = document.getElementById("grado").value;
      const grupo = document.getElementById("grupo").value;

      if (!grado || !grupo) {
        alert("Selecciona grado y grupo.");
        return;
      }
      const materia = document.getElementById("materia").value;
if (!materia) {
  alert("Selecciona una materia.");
  return;
}

      const { data, error } = await supabase
        .from('usuarios')
        .select('*')
        .eq('grado', grado)
        .eq('grupo', grupo)
        .eq('tipo', 'alumno');

      if (error || !data.length) {
        alert("No se encontraron alumnos.");
        return;
      }

      const cuerpo = document.getElementById("cuerpo-tabla");
      cuerpo.innerHTML = "";

      data.forEach((alumno, index) => {
        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td>${index + 1}</td>
          <td>${alumno.matricula}</td>
          <td>${alumno.nombre} ${alumno.apellido_paterno} ${alumno.apellido_materno}</td>
          <td><input type="checkbox" data-matricula="${alumno.matricula}" class="asistio"></td>
          <td><textarea class="observacion" data-matricula="${alumno.matricula}"></textarea></td>
        `;
        cuerpo.appendChild(fila);
      });
    }

    async function guardarAsistencia() {
  const grado = document.getElementById("grado").value;
  const grupo = document.getElementById("grupo").value;
  const fechaSeleccionada = document.getElementById("fecha").value;
  const checkboxes = document.querySelectorAll('.asistio');
  const observaciones = document.querySelectorAll('.observacion');

  for (let i = 0; i < checkboxes.length; i++) {
    const matricula = checkboxes[i].dataset.matricula;
    const asistencia = checkboxes[i].checked;
    const observacion = observaciones[i].value;

    const usuario = await supabase
      .from('usuarios')
      .select('*')
      .eq('matricula', matricula)
      .single();

    if (usuario.error) continue;

    await supabase
      .from('asistencias_esperadas')
      .insert([{
        matricula: usuario.data.matricula,
        nombres: usuario.data.nombre,
        apellido_paterno: usuario.data.apellido_paterno,
        apellido_materno: usuario.data.apellido_materno,
        grado: usuario.data.grado,
        grupo: usuario.data.grupo,
        fecha: fechaSeleccionada,
        asistencia: asistencia,
        materia: materia,
        observaciones: observacion
      }]);
  }

  alert("✅ Pase de lista guardado correctamente.");
}
  </script>
</body>
</html>
